(function(g,D,w,p){function F(a){g.error("Not implemented: "+(a||""))}function m(a,b){a||g.error("Assertion failed"+(b?": "+b:""))}function s(a,b){var c,d,e=D.console?D.console[a]:null;if(e)if(e.apply)e.apply(D.console,b);else{d="";for(c=0;c<b.length;c++)d+=b[c];e(d)}}function L(a,b,c,d){var e,f,h,k=g.map(g.trim(a).split("."),function(a){return parseInt(a,10)}),l=g.map(Array.prototype.slice.call(arguments,1),function(a){return parseInt(a,10)});for(e=0;e<l.length;e++)if(f=k[e]||0,h=l[e]||0,f!==h)return f> h;return!0}function G(a,b,c,d,e){return function(){var c=b[a],h=d[a],k=b.ext[e],g=function(){return c.apply(b,arguments)};return function(){var a=b._local,c=b._super;try{return b._local=k,b._super=g,h.apply(b,arguments)}finally{b._local=a,b._super=c}}}()}function z(a,b){return a===p?g.Deferred(function(){this.resolve()}).promise():g.Deferred(function(){this.resolveWith(a,b)}).promise()}function A(a,b){return a===p?g.Deferred(function(){this.reject()}).promise():g.Deferred(function(){this.rejectWith(a, b)}).promise()}function H(a,b){return function(){a.resolveWith(b)}}function I(a){a=a.toLowerCase();return function(b){return 0<=b.title.toLowerCase().indexOf(a)}}function v(a,b){var c,d,e;this.parent=a;this.tree=a.tree;this.li=this.ul=null;this.isStatusNode=!1;this.data={};c=0;for(d=x.length;c<d;c++)e=x[c],this[e]=b[e];b.data&&g.extend(this.data,b.data);for(e in b)B[e]||g.isFunction(b[e])||J[e]||(this.data[e]=b[e]);null==this.key&&(this.key="_"+t._nextNodeKey++);b.active&&(m(null===this.tree.activeNode, "only one active node allowed"),this.tree.activeNode=this);this.children=null;(c=b.children)&&c.length&&this._setChildren(c)}function E(a){this.widget=a;this.$div=a.element;this.options=a.options;this.ext={};this.data={};this._id=g.ui.fancytree._nextId++;this._ns=".fancytree-"+this._id;this.systemFocusElement=this.lastSelectedNode=this._hasFocus=this.focusNode=this.activeNode=null;this.statusClassPropName="span";this.nodeContainerAttrName=this.ariaPropName="li";this.$div.find(">ul.fancytree-container").remove(); this.rootNode=new v({tree:this},{title:"root",key:"root_"+this._id,children:null});this.rootNode.parent=null;this.$container=a=g("<ul>",{"class":"ui-fancytree fancytree-container"}).appendTo(this.$div);this.rootNode.ul=a[0];null==this.options.debugLevel&&(this.options.debugLevel=t.debugLevel);this.$container.attr("tabindex",this.options.tabbable?"0":"-1");this.options.aria&&this.$container.attr("role","tree").attr("aria-multiselectable",!0)}if(g.ui.fancytree&&g.ui.fancytree.version)g.ui.fancytree.warn("Fancytree: ignored duplicate include"); else{var u,t=null,C="active expanded focus folder lazy selected unselectable".split(" "),K={},x="expanded extraClasses folder hideCheckbox key lazy selected title tooltip unselectable".split(" "),B={},J={active:!0,children:!0,data:!0,focus:!0};for(u=0;u<C.length;u++)K[C[u]]=!0;for(u=0;u<x.length;u++)B[x[u]]=!0;v.prototype={_findDirectChild:function(a){var b,c,d=this.children;if(d)if("string"===typeof a)for(b=0,c=d.length;b<c;b++){if(d[b].key===a)return d[b]}else{if("number"===typeof a)return this.children[a]; if(a.parent===this)return a}return null},_setChildren:function(a){m(a&&(!this.children||0===this.children.length),"only init supported");this.children=[];for(var b=0,c=a.length;b<c;b++)this.children.push(new v(this,a[b]))},addChildren:function(a,b){var c,d;d=null;var e=[];g.isPlainObject(a)&&(a=[a]);this.children||(this.children=[]);c=0;for(d=a.length;c<d;c++)e.push(new v(this,a[c]));d=e[0];null==b?this.children=this.children.concat(e):(b=this._findDirectChild(b),c=g.inArray(b,this.children),m(0<= c,"insertBefore must be an existing child"),this.children.splice.apply(this.children,[c,0].concat(e)));(!this.parent||this.parent.ul||this.tr)&&this.render();3===this.tree.options.selectMode&&this.fixSelection3FromEndNodes();return d},addNode:function(a,b){if(b===p||"over"===b)b="child";switch(b){case "after":return this.getParent().addChildren(a,this.getNextSibling());case "before":return this.getParent().addChildren(a,this);case "child":case "over":return this.addChildren(a)}m(!1,"Invalid mode: "+ b)},applyPatch:function(a){if(null===a)return this.remove(),z(this);var b,c,d={children:!0,expanded:!0,parent:!0};for(b in a)c=a[b],d[b]||g.isFunction(c)||(B[b]?this[b]=c:this.data[b]=c);a.hasOwnProperty("children")&&(this.removeChildren(),a.children&&this._setChildren(a.children));this.isVisible()&&(this.renderTitle(),this.renderStatus());return a.hasOwnProperty("expanded")?this.setExpanded(a.expanded):z(this)},collapseSiblings:function(){return this.tree._callHook("nodeCollapseSiblings",this)}, copyTo:function(a,b,c){return a.addNode(this.toDict(!0,c),b)},countChildren:function(a){var b=this.children,c,d;if(!b)return 0;d=b.length;if(!1!==a)for(a=0,c=d;a<c;a++)d+=b[a].countChildren();return d},debug:function(a){2<=this.tree.options.debugLevel&&(Array.prototype.unshift.call(arguments,this.toString()),s("debug",arguments))},discard:function(){if(this.lazy&&g.isArray(this.children))return this.removeChildren(),this.setExpanded(!1)},findAll:function(a){a=g.isFunction(a)?a:I(a);var b=[];this.visit(function(c){a(c)&& b.push(c)});return b},findFirst:function(a){a=g.isFunction(a)?a:I(a);var b=null;this.visit(function(c){if(a(c))return b=c,!1});return b},_changeSelectStatusAttrs:function(a){var b=!1;switch(a){case !1:b=this.selected||this.partsel;this.partsel=this.selected=!1;break;case !0:b=!this.selected||!this.partsel;this.partsel=this.selected=!0;break;case p:b=this.selected||!this.partsel;this.selected=!1;this.partsel=!0;break;default:m(!1,"invalid state: "+a)}this.debug("fixSelection3AfterLoad() _changeSelectStatusAttrs()", a,b);b&&this.renderStatus();return b},fixSelection3AfterClick:function(){var a=this.isSelected();this.visit(function(b){b._changeSelectStatusAttrs(a)});this.fixSelection3FromEndNodes()},fixSelection3FromEndNodes:function(){function a(b){var c,d,e,f,h,k=b.children;if(k){f=!0;h=!1;c=0;for(d=k.length;c<d;c++)e=k[c],e=a(e),!1!==e&&(h=!0),!0!==e&&(f=!1);c=f?!0:h?p:!1}else c=!!b.selected;b._changeSelectStatusAttrs(c);return c}m(3===this.tree.options.selectMode,"expected selectMode 3");a(this);this.visitParents(function(a){var c, d,e,f=a.children,h=!0,k=!1;c=0;for(d=f.length;c<d;c++){e=f[c];if(e.selected||e.partsel)k=!0;e.unselectable||e.selected||(h=!1)}a._changeSelectStatusAttrs(h?!0:k?p:!1)})},fromDict:function(a){for(var b in a)B[b]?this[b]=a[b]:"data"===b?g.extend(this.data,a.data):g.isFunction(a[b])||J[b]||(this.data[b]=a[b]);a.children?(this.removeChildren(),this.addChildren(a.children)):this.renderTitle()},getChildren:function(){return this.hasChildren()===p?p:this.children},getFirstChild:function(){return this.children? this.children[0]:null},getIndex:function(){return g.inArray(this,this.parent.children)},getIndexHier:function(a){a=a||".";var b=[];g.each(this.getParentList(!1,!0),function(a,d){b.push(d.getIndex()+1)});return b.join(a)},getKeyPath:function(a){var b=[],c=this.tree.options.keyPathSeparator;this.visitParents(function(a){a.parent&&b.unshift(a.key)},!a);return c+b.join(c)},getLastChild:function(){return this.children?this.children[this.children.length-1]:null},getLevel:function(){for(var a=0,b=this.parent;b;)a++, b=b.parent;return a},getNextSibling:function(){if(this.parent){var a,b,c=this.parent.children;a=0;for(b=c.length-1;a<b;a++)if(c[a]===this)return c[a+1]}return null},getParent:function(){return this.parent},getParentList:function(a,b){for(var c=[],d=b?this:this.parent;d;)(a||d.parent)&&c.unshift(d),d=d.parent;return c},getPrevSibling:function(){if(this.parent){var a,b,c=this.parent.children;a=1;for(b=c.length;a<b;a++)if(c[a]===this)return c[a-1]}return null},hasChildren:function(){return this.lazy? null==this.children?p:0===this.children.length?!1:1===this.children.length&&this.children[0].isStatusNode?p:!0:!!this.children},hasFocus:function(){return this.tree.hasFocus()&&this.tree.focusNode===this},isActive:function(){return this.tree.activeNode===this},isChildOf:function(a){return this.parent&&this.parent===a},isDescendantOf:function(a){if(!a||a.tree!==this.tree)return!1;for(var b=this.parent;b;){if(b===a)return!0;b=b.parent}return!1},isExpanded:function(){return!!this.expanded},isFirstSibling:function(){var a= this.parent;return!a||a.children[0]===this},isFolder:function(){return!!this.folder},isLastSibling:function(){var a=this.parent;return!a||a.children[a.children.length-1]===this},isLazy:function(){return!!this.lazy},isLoading:function(){F()},isRoot:function(){return this.tree.rootNode===this},isSelected:function(){return!!this.selected},isVisible:function(){var a,b,c=this.getParentList(!1,!1);a=0;for(b=c.length;a<b;a++)if(!c[a].expanded)return!1;return!0},makeVisible:function(){var a,b,c=this.getParentList(!1, !1);a=0;for(b=c.length;a<b;a++)c[a].setExpanded(!0)},moveTo:function(a,b,c){if(b===p||"over"===b)b="child";var d,e=this.parent,f="child"===b?a:a.parent;if(this!==a){if(!this.parent)throw"Cannot move system root";if(f.isDescendantOf(this))throw"Cannot move a node to it's own descendant";1===this.parent.children.length?(this.parent.children=this.parent.lazy?[]:null,this.parent.expanded=!1):(d=g.inArray(this,this.parent.children),m(0<=d),this.parent.children.splice(d,1));this.parent=f;if(f.hasChildren())switch(b){case "child":f.children.push(this); break;case "before":d=g.inArray(a,f.children);m(0<=d);f.children.splice(d,0,this);break;case "after":d=g.inArray(a,f.children);m(0<=d);f.children.splice(d+1,0,this);break;default:throw"Invalid mode "+b;}else f.children=[this];c&&a.visit(c,!0);this.tree!==a.tree&&(this.warn("Cross-tree moveTo is experimantal!"),this.visit(function(b){b.tree=a.tree},!0));f.expanded||e.ul.removeChild(this.li);e.isDescendantOf(f)||e.render();f.isDescendantOf(e)||f===e||f.render()}},navigate:function(a,b){function c(a){if(a)return a.makeVisible(), !1===b?a.setFocus():a.setActive()}var d,e;d=g.ui.keyCode;var f=null;switch(a){case d.BACKSPACE:this.parent&&this.parent.parent&&c(this.parent);break;case d.LEFT:this.expanded?(this.setExpanded(!1),c(this)):this.parent&&this.parent.parent&&c(this.parent);break;case d.RIGHT:this.expanded||!this.children&&!this.lazy?this.children&&this.children.length&&c(this.children[0]):(this.setExpanded(),c(this));break;case d.UP:for(f=this.getPrevSibling();f&&f.expanded&&f.children&&f.children.length;)f=f.children[f.children.length- 1];!f&&this.parent&&this.parent.parent&&(f=this.parent);c(f);break;case d.DOWN:if(this.expanded&&this.children&&this.children.length)f=this.children[0];else for(e=this.getParentList(!1,!0),d=e.length-1;0<=d&&!(f=e[d].getNextSibling());d--);c(f)}},lazyLoad:function(a){(a||this.hasChildren()===p)&&this.discard();m(!g.isArray(this.children));a=this.tree._triggerNodeEvent("lazyload",this);m("boolean"!==typeof a,"lazyload event must return source in data.result");return this.tree._callHook("nodeLoadChildren", this,a)},render:function(a,b){return this.tree._callHook("nodeRender",this,a,b)},renderTitle:function(){return this.tree._callHook("nodeRenderTitle",this)},renderStatus:function(){return this.tree._callHook("nodeRenderStatus",this)},remove:function(){return this.parent.removeChild(this)},removeChild:function(a){return this.tree._callHook("nodeRemoveChild",this,a)},removeChildren:function(){return this.tree._callHook("nodeRemoveChildren",this)},scheduleAction:function(a,b){this.tree.timer&&clearTimeout(this.tree.timer); this.tree.timer=null;var c=this;switch(a){case "cancel":break;case "expand":this.tree.timer=setTimeout(function(){c.tree.debug("setTimeout: trigger expand");c.setExpanded(!0)},b);break;case "activate":this.tree.timer=setTimeout(function(){c.tree.debug("setTimeout: trigger activate");c.setActive(!0)},b);break;default:throw"Invalid mode "+a;}},scrollIntoView:function(a,b){a=!0===a?{duration:200,queue:!1}:a;var c,d=new g.Deferred,e=g(this.span).position().top;c=g(this.span).height();var f=this.tree.$container, h=f[0].scrollTop,k=Math.max(0,f.innerHeight()-f[0].clientHeight),k=f.height()-k,l=null;0>e?l=h+e:e+c>k&&(l=h+e-k+c,b&&(c=b?g(b.span).position().top:0,e-c>k&&(l=h+e)));null!==l?a?f.animate({scrollTop:l},a):(f[0].scrollTop=l,d.resolveWith(this)):d.resolveWith(this);return d.promise()},setActive:function(a){return this.tree._callHook("nodeSetActive",this,a)},setExpanded:function(a){return this.tree._callHook("nodeSetExpanded",this,a)},setFocus:function(a){return this.tree._callHook("nodeSetFocus",this, a)},setSelected:function(a){return this.tree._callHook("nodeSetSelected",this,a)},setTitle:function(a){this.title=a;this.renderTitle()},sortChildren:function(a,b){var c,d,e=this.children;if(e){a=a||function(a,b){var c=a.title.toLowerCase(),d=b.title.toLowerCase();return c===d?0:c>d?1:-1};e.sort(a);if(b)for(c=0,d=e.length;c<d;c++)e[c].children&&e[c].sortChildren(a,"$norender$");"$norender$"!==b&&this.render()}},toDict:function(a,b){var c,d,e,f={},h=this;g.each(x,function(a,b){if(h[b]||!1===h[b])f[b]= h[b]});g.isEmptyObject(this.data)||(f.data=g.extend({},this.data),g.isEmptyObject(f.data)&&delete f.data);b&&b(f);if(a&&this.hasChildren())for(f.children=[],c=0,d=this.children.length;c<d;c++)e=this.children[c],e.isStatusNode||f.children.push(e.toDict(!0,b));return f},toggleExpanded:function(){return this.tree._callHook("nodeToggleExpanded",this)},toggleSelected:function(){return this.tree._callHook("nodeToggleSelected",this)},toString:function(){return"<FancytreeNode(#"+this.key+", '"+this.title+ "')>"},visit:function(a,b){var c,d,e=!0,f=this.children;if(!0===b&&(e=a(this),!1===e||"skip"===e))return e;if(f)for(c=0,d=f.length;c<d&&(e=f[c].visit(a,!0),!1!==e);c++);return e},visitParents:function(a,b){if(b&&!1===a(this))return!1;for(var c=this.parent;c;){if(!1===a(c))return!1;c=c.parent}return!0},warn:function(a){Array.prototype.unshift.call(arguments,this.toString());s("warn",arguments)}};E.prototype={_makeHookContext:function(a,b,c){var d;a.node!==p?(b&&a.originalEvent!==b&&g.error("invalid args"), d=a):a.tree?(d=a.tree,d={node:a,tree:d,widget:d.widget,options:d.widget.options,originalEvent:b}):a.widget?d={node:null,tree:a,widget:a.widget,options:a.widget.options,originalEvent:b}:g.error("invalid args");c&&g.extend(d,c);return d},_callHook:function(a,b,c){var d=this._makeHookContext(b),e=this[a],f=Array.prototype.slice.call(arguments,2);g.isFunction(e)||g.error("_callHook('"+a+"') is not a function");f.unshift(d);return e.apply(this,f)},activateKey:function(a){(a=this.getNodeByKey(a))?a.setActive(): this.activeNode&&this.activeNode.setActive(!1);return a},applyPatch:function(a){var b,c,d,e,f=a.length,h=[];for(c=0;c<f;c++)d=a[c],m(2===d.length,"patchList must be an array of length-2-arrays"),b=d[0],d=d[1],(e=null===b?this.rootNode:this.getNodeByKey(b))?(b=new g.Deferred,h.push(b),e.applyPatch(d).always(H(b,e))):this.warn("could not find node with key '"+b+"'");return g.when.apply(g,h).promise()},count:function(){return this.rootNode.countChildren()},debug:function(a){2<=this.options.debugLevel&& (Array.prototype.unshift.call(arguments,this.toString()),s("debug",arguments))},generateFormElements:function(a,b){var c,d=!1!==a?"ft_"+this._id:a,e=!1!==b?"ft_"+this._id+"_active":b;c="fancytree_result_"+this._id;var f=this.$container.find("div#"+c);f.length?f.empty():f=g("<div>",{id:c}).hide().appendTo(this.$container);d&&(c=this.getSelectedNodes(3===this.options.selectMode),g.each(c,function(a,b){f.append(g("<input>",{type:"checkbox",name:d,value:b.key,checked:!0}))}));e&&this.activeNode&&f.append(g("<input>", {type:"radio",name:e,value:this.activeNode.key,checked:!0}))},getActiveNode:function(){return this.activeNode},getFirstChild:function(){return this.rootNode.getFirstChild()},getFocusNode:function(a){return this.focusNode},getNodeByKey:function(a,b){var c,d;if(!b&&(c=w.getElementById(this.options.idPrefix+a)))return c.ftnode?c.ftnode:null;b=b||this.rootNode;d=null;b.visit(function(b){if(b.key===a)return d=b,!1},!0);return d},getSelectedNodes:function(a){var b=[];this.rootNode.visit(function(c){if(c.selected&& (b.push(c),!0===a))return"skip"});return b},hasFocus:function(){return!!this._hasFocus},info:function(a){1<=this.options.debugLevel&&(Array.prototype.unshift.call(arguments,this.toString()),s("info",arguments))},loadKeyPath:function(a,b,c){function d(a,c,d){b.call(n,c,"loading");c.lazyLoad().done(function(){n.loadKeyPath.call(n,h[a],b,c).always(H(d,n))}).fail(function(e){n.warn("loadKeyPath: error loading: "+a+" (parent: "+l+")");b.call(n,c,"error");d.reject()})}var e,f,h,k,l=c||this.rootNode,y=this.options.keyPathSeparator, n=this;g.isArray(a)||(a=[a]);h={};for(e=0;e<a.length;e++)for(c=a[e],c.charAt(0)===y&&(c=c.substr(1)),k=c.split(y);k.length;)if(f=k.shift(),c=l._findDirectChild(f))if(0===k.length){b.call(this,c,"ok");break}else if(c.lazy&&c.hasChildren()===p){b.call(this,c,"loaded");h[f]?h[f].push(k.join(y)):h[f]=[k.join(y)];break}else b.call(this,c,"loaded"),l=c;else{this.warn("loadKeyPath: key not found: "+f+" (parent: "+l+")");b.call(this,f,"error");break}a=[];for(f in h)c=l._findDirectChild(f),e=new g.Deferred, a.push(e),d(f,c,e);return g.when.apply(g,a).promise()},nodeClick:function(a){var b,c,d=a.originalEvent;b=a.targetType;var e=a.node;if("expander"===b)this._callHook("nodeToggleExpanded",a);else if("checkbox"===b)this._callHook("nodeToggleSelected",a),this._callHook("nodeSetFocus",a,!0);else{c=!1;b=!0;if(e.folder)switch(a.options.clickFolderMode){case 2:c=!0;b=!1;break;case 3:c=b=!0}b&&(this.nodeSetFocus(a),this._callHook("nodeSetActive",a,!0));c&&this._callHook("nodeToggleExpanded",a)}"a"===d.target.localName&& "fancytree-title"===d.target.className&&d.preventDefault()},nodeCollapseSiblings:function(a){var b,c,d=a.node;if(d.parent)for(a=d.parent.children,b=0,c=a.length;b<c;b++)a[b]!==d&&a[b].expanded&&this._callHook("nodeSetExpanded",a[b],!1)},nodeDblclick:function(a){"title"===a.targetType&&4===a.options.clickFolderMode&&this._callHook("nodeToggleExpanded",a);"title"===a.targetType&&a.originalEvent.preventDefault()},nodeKeydown:function(a){var b=a.originalEvent,c=a.node,d=a.tree,e=a.options,f=!0,h=!(b.ctrlKey|| !e.autoActivate),k=g.ui.keyCode;c||(this.rootNode.getFirstChild().setFocus(),c=a.node=this.focusNode,c.debug("Keydown force focus on first node"));switch(b.which){case k.NUMPAD_ADD:case 187:d.nodeSetExpanded(a,!0);break;case k.NUMPAD_SUBTRACT:case 189:d.nodeSetExpanded(a,!1);break;case k.SPACE:e.checkbox?d.nodeToggleSelected(a):d.nodeSetActive(a,!0);break;case k.ENTER:d.nodeSetActive(a,!0);break;case k.BACKSPACE:case k.LEFT:case k.RIGHT:case k.UP:case k.DOWN:c.navigate(b.which,h);break;default:f= !1}f&&b.preventDefault()},nodeLoadChildren:function(a,b){var c,d,e=a.tree,f=a.node;g.isFunction(b)&&(b=b());b.url&&(c=g.extend({},a.options.ajax,b),c.debugDelay?(d=c.debugDelay,g.isArray(d)&&(d=d[0]+Math.random()*(d[1]-d[0])),f.debug("nodeLoadChildren waiting debug delay "+Math.round(d)+"ms"),c.debugDelay=!1,b=g.Deferred(function(a){setTimeout(function(){g.ajax(c).done(function(){a.resolveWith(this,arguments)}).fail(function(){a.rejectWith(this,arguments)})},d)})):b=g.ajax(c),b=b.pipe(function(b, c,d){"string"===typeof b&&g.error("Ajax request returned a string (did you get the JSON dataType wrong?).");a.options.postProcess?(c=e._triggerNodeEvent("postProcess",a,a.originalEvent,{response:b,dataType:this.dataType}),b=g.isArray(c)?c:b):b&&b.hasOwnProperty("d")&&a.options.enableAspx&&(b="string"===typeof b.d?g.parseJSON(b.d):b.d);return b},function(a,b,c){return e._makeHookContext(f,null,{error:a,args:Array.prototype.slice.call(arguments),message:c,details:a.status+": "+c})}));g.isFunction(b.promise)&& (e.nodeSetStatus(a,"loading"),b.done(function(){e.nodeSetStatus(a,"ok")}).fail(function(b){var c;c=b.node&&b.error&&b.message?b:e._makeHookContext(f,null,{error:b,args:Array.prototype.slice.call(arguments),message:b?b.message||b.toString():""});e._triggerNodeEvent("loaderror",c,null);e.nodeSetStatus(a,"error",c.message,c.details)}));return g.when(b).done(function(a){var b;g.isPlainObject(a)&&(m(g.isArray(a.children),"source must contain (or be) an array of children"),m(f.isRoot(),"source may only be an object for root nodes"), b=a,a=a.children,delete b.children,g.extend(e.data,b));m(g.isArray(a),"expected array of children");f._setChildren(a);f.parent&&e._triggerNodeEvent("loadChildren",f)})},nodeLoadKeyPath:function(a,b){},nodeMakeVisible:function(a){var b,c=a.node.getParentList(!1,!1);a=0;for(b=c.length;a<b;a++)c[a].setExpanded(!0)},nodeRemoveChild:function(a,b){var c;c=a.node;var d=a.options,e=g.extend({},a,{node:b}),f=c.children;t.debug("nodeRemoveChild()",c.toString(),b.toString());if(1===f.length)return m(b===f[0]), this.nodeRemoveChildren(a);this.activeNode&&(b===this.activeNode||this.activeNode.isDescendantOf(b))&&this.activeNode.setActive(!1);this.focusNode&&(b===this.focusNode||this.focusNode.isDescendantOf(b))&&(this.focusNode=null);this.nodeRemoveMarkup(e);this.nodeRemoveChildren(e);c=g.inArray(b,f);m(0<=c);b.visit(function(a){a.parent=null},!0);d.removeNode&&d.removeNode.call(a.tree,{type:"removeNode"},e);f.splice(c,1)},nodeRemoveChildMarkup:function(a){a=a.node;t.debug("nodeRemoveChildMarkup()",a.toString()); a.ul&&(g(a.ul).remove(),a.visit(function(a){a.li=a.ul=null}),a.ul=null)},nodeRemoveChildren:function(a){var b,c=a.node,d=c.children,e=a.options;t.debug("nodeRemoveChildren()",c.toString());d&&(this.activeNode&&this.activeNode.isDescendantOf(c)&&this.activeNode.setActive(!1),this.focusNode&&this.focusNode.isDescendantOf(c)&&(this.focusNode=null),this.nodeRemoveChildMarkup(a),b=g.extend({},a),c.visit(function(c){c.parent=null;e.removeNode&&(b.node=c,e.removeNode.call(a.tree,{type:"removeNode"},b))}), c.children=p,this.nodeRenderStatus(a))},nodeRemoveMarkup:function(a){var b=a.node;t.debug("nodeRemoveMarkup()",b.toString());b.li&&(g(b.li).remove(),b.li=null);this.nodeRemoveChildMarkup(a)},nodeRender:function(a,b,c,d,e){var f,h=a.node;f=a.tree;var k=a.options,l=k.aria,p=!1,n=h.parent,r=!n,q=h.children;if(r||n.ul){m(r||n.ul,"parent UL must exist");r||(h.li&&(b||h.li.parentNode!==h.parent.ul)&&(h.li.parentNode!==h.parent.ul&&this.warn("unlink "+h+" (must be child of "+h.parent+")"),this.nodeRemoveMarkup(a)), h.li||(p=!0,h.li=w.createElement("li"),h.li.ftnode=h,h.key&&k.generateIds&&(h.li.id=k.idPrefix+h.key),h.span=w.createElement("span"),h.span.className="fancytree-node",l&&g(h.span).attr("aria-labelledby","ftal_"+h.key),h.li.appendChild(h.span),this.nodeRenderTitle(a),k.createNode&&k.createNode.call(f,{type:"createNode"},a)),k.renderNode&&k.renderNode.call(f,{type:"renderNode"},a));if(q){if(r||h.expanded||!0===c){if(!h.ul){h.ul=w.createElement("ul");if(!0===d&&!e||!h.expanded)h.ul.style.display="none"; l&&g(h.ul).attr("role","group");h.li?h.li.appendChild(h.ul):h.tree.$div.append(h.ul)}d=0;for(e=q.length;d<e;d++)f=g.extend({},a,{node:q[d]}),this.nodeRender(f,b,c,!1,!0);b=h.ul.firstChild;d=0;for(e=q.length-1;d<e;d++)c=q[d],f=b.ftnode,c!==f?(h.debug("_fixOrder: mismatch at index "+d+": "+c+" != "+f),h.ul.insertBefore(c.li,f.li)):b=b.nextSibling}}else h.ul&&(this.warn("remove child markup for "+h),this.nodeRemoveChildMarkup(a));r||(this.nodeRenderStatus(a),p&&n.ul.appendChild(h.li))}},nodeRenderTitle:function(a, b){var c,d,e,f,h=a.node;c=a.tree;f=a.options;var g=f.aria;e=h.getLevel();var l=[];d=h.data.icon;b!==p&&(h.title=b);h.span&&(e<f.minExpandLevel?1<e&&(g?l.push("<span role='button' class='fancytree-expander'></span>"):l.push("<span class='fancytree-expander'></span>")):g?l.push("<span role='button' class='fancytree-expander'></span>"):l.push("<span class='fancytree-expander'></span>"),f.checkbox&&!0!==h.hideCheckbox&&!h.isStatusNode&&(g?l.push("<span role='checkbox' class='fancytree-checkbox'></span>"): l.push("<span class='fancytree-checkbox'></span>")),e=g?" role='img'":"",d&&"string"===typeof d?(d="/"===d.charAt(0)?d:f.imagePath+d,l.push("<img src='"+d+"' alt='' />")):h.data.iconclass?l.push("<span "+e+" class='fancytree-custom-icon "+h.data.iconclass+"'></span>"):(!0===d||!1!==d&&!1!==f.icons)&&l.push("<span "+e+" class='fancytree-icon'></span>"),d="",f.renderTitle&&(d=f.renderTitle.call(c,{type:"renderTitle"},a)||""),d||(f=h.tooltip?" title='"+h.tooltip.replace(/\"/g,"&quot;")+"'":"",c=g?" id='ftal_"+ h.key+"'":"",d="<span "+(g?" role='treeitem'":"")+" class='fancytree-title'"+c+f+">"+h.title+"</span>"),l.push(d),h.span.innerHTML=l.join(""))},nodeRenderStatus:function(a){var b=a.node,c=a.tree,d=a.options;a=b.hasChildren();var e=b.isLastSibling(),f=d.aria,h=g(b.span).find(".fancytree-title"),d=d._classNames,k=[],l=b[c.statusClassPropName];l&&(k.push(d.node),c.activeNode===b&&k.push(d.active),c.focusNode===b?(k.push(d.focused),f&&h.attr("aria-activedescendant",!0)):f&&h.removeAttr("aria-activedescendant"), b.expanded?(k.push(d.expanded),f&&h.attr("aria-expanded",!0)):f&&h.removeAttr("aria-expanded"),b.folder&&k.push(d.folder),!1!==a&&k.push(d.hasChildren),e&&k.push(d.lastsib),b.lazy&&null==b.children&&k.push(d.lazy),b.partsel&&k.push(d.partsel),b.selected?(k.push(d.selected),f&&h.attr("aria-selected",!0)):f&&h.attr("aria-selected",!1),b.extraClasses&&k.push(b.extraClasses),!1===a?k.push(d.combinedExpanderPrefix+"n"+(e?"l":"")):k.push(d.combinedExpanderPrefix+(b.expanded?"e":"c")+(b.lazy&&null==b.children? "d":"")+(e?"l":"")),k.push(d.combinedIconPrefix+(b.expanded?"e":"c")+(b.folder?"f":"")),l.className=k.join(" "),b.li&&(b.li.className=e?d.lastsib:""))},nodeSetActive:function(a,b){var c,d=a.node,e=a.tree,f=a.options;c=d===e.activeNode;b=!1!==b;d.debug("nodeSetActive",b);if(c===b)return z(d);if(b&&!1===this._triggerNodeEvent("beforeActivate",d,a.originalEvent))return A(d,["rejected"]);b?(e.activeNode&&(m(e.activeNode!==d,"node was active (inconsistency)"),c=g.extend({},a,{node:e.activeNode}),e.nodeSetActive(c, !1),m(null===e.activeNode,"deactivate was out of sync?")),f.activeVisible&&e.nodeMakeVisible(a),e.activeNode=d,e.nodeRenderStatus(a),e.nodeSetFocus(a),e._triggerNodeEvent("activate",d)):(m(e.activeNode===d,"node was not active (inconsistency)"),e.activeNode=null,this.nodeRenderStatus(a),a.tree._triggerNodeEvent("deactivate",d))},nodeSetExpanded:function(a,b){var c,d,e,f,h,k,l=a.node,m=a.tree,n=a.options;b=!1!==b;l.debug("nodeSetExpanded("+b+")");if(l.expanded&&b||!l.expanded&&!b)return l.debug("nodeSetExpanded("+ b+"): nothing to do"),z(l);if(!b||l.lazy||l.hasChildren()){if(!b&&l.getLevel()<n.minExpandLevel)return A(l,["locked"]);if(!1===this._triggerNodeEvent("beforeExpand",l,a.originalEvent))return A(l,["rejected"])}else return A(l,["empty"]);d=new g.Deferred;if(b&&!l.expanded&&n.autoCollapse){h=l.getParentList(!1,!0);k=n.autoCollapse;try{for(n.autoCollapse=!1,e=0,f=h.length;e<f;e++)this._callHook("nodeCollapseSiblings",h[e])}finally{n.autoCollapse=k}}d.done(function(){a.tree._triggerNodeEvent(b?"expand": "collapse",a);n.autoScroll&&l.getLastChild().scrollIntoView(!0,l)});c=function(c){var d,e;l.expanded=b;m._callHook("nodeRender",a,!1,!1,!0);if(l.ul)if(d="none"!==l.ul.style.display,e=!!l.expanded,d===e)l.warn("nodeSetExpanded: UL.style.display already set");else{if(n.fx){d=n.fx.duration||200;e=n.fx.easing;l.debug("nodeSetExpanded: animate start...");g(l.ul).animate(n.fx,d,e,function(){l.debug("nodeSetExpanded: animate done");c()});return}l.ul.style.display=l.expanded||!parent?"":"none"}c()};b&&l.lazy&& l.hasChildren()===p?(l.debug("nodeSetExpanded: load start..."),l.lazyLoad().done(function(){l.debug("nodeSetExpanded: load done");d.notifyWith&&d.notifyWith(l,["loaded"]);c(function(){d.resolveWith(l)})}).fail(function(a){c(function(){d.rejectWith(l,["load failed ("+a+")"])})})):c(function(){d.resolveWith(l)});l.debug("nodeSetExpanded: returns");return d.promise()},nodeSetFocus:function(a,b){a.node.debug("nodeSetFocus("+b+")");var c,d=a.tree,e=a.node;b=!1!==b;if(d.focusNode){if(d.focusNode===e&&b){e.debug("nodeSetFocus("+ b+"): nothing to do");return}c=g.extend({},a,{node:d.focusNode});d.focusNode=null;this._triggerNodeEvent("blur",c);this._callHook("nodeRenderStatus",c)}b&&(this.hasFocus()||(e.debug("nodeSetFocus: forcing container focus"),this._callHook("treeSetFocus",a,!0,!0)),this.nodeMakeVisible(a),d.focusNode=e,this._triggerNodeEvent("focus",a),a.options.autoScroll&&e.scrollIntoView(),this._callHook("nodeRenderStatus",a))},nodeSetSelected:function(a,b){var c=a.node,d=a.tree,e=a.options;b=!1!==b;c.debug("nodeSetSelected("+ b+")",a);if(!c.unselectable){if(c.selected&&b||!c.selected&&!b||!1===this._triggerNodeEvent("beforeSelect",c,a.originalEvent))return!!c.selected;b&&1===e.selectMode?d.lastSelectedNode&&d.lastSelectedNode.setSelected(!1):3===e.selectMode&&(c.selected=b,c.fixSelection3AfterClick());c.selected=b;this.nodeRenderStatus(a);d.lastSelectedNode=b?c:null;d._triggerNodeEvent("select",a)}},nodeSetStatus:function(a,b,c,d){var e,f=a.node,h=a.tree,k=a.options._classNames;a=function(){var a=f.children?f.children[0]: null;if(a&&a.isStatusNode){try{f.ul&&(f.ul.removeChild(a.li),a.li=null)}catch(b){}1===f.children.length?f.children=[]:f.children.shift()}};e=function(a){var b=f.children?f.children[0]:null;b&&b.isStatusNode?(g.extend(b,a),h._callHook("nodeRender",b)):(a.key="_statusNode",f._setChildren([a]),f.children[0].isStatusNode=!0,h.render());return f.children[0]};switch(b){case "ok":a();g(f.span).removeClass(k.loading);g(f.span).removeClass(k.error);break;case "loading":g(f.span).removeClass(k.error);g(f.span).addClass(k.loading); f.parent||e({title:h.options.strings.loading+(c?" ("+c+") ":""),tooltip:d,extraClasses:"fancytree-statusnode-wait"});break;case "error":g(f.span).removeClass(k.loading);g(f.span).addClass(k.error);e({title:h.options.strings.loadError+(c?" ("+c+") ":""),tooltip:d,extraClasses:"fancytree-statusnode-error"});break;default:g.error("invalid status "+b)}},nodeToggleExpanded:function(a){return this.nodeSetExpanded(a,!a.node.expanded)},nodeToggleSelected:function(a){return this.nodeSetSelected(a,!a.node.selected)}, treeClear:function(a){a=a.tree;a.activeNode=null;a.focusNode=null;a.$div.find(">ul.fancytree-container").empty();a.rootNode.children=null},treeCreate:function(a){},treeDestroy:function(a){},treeInit:function(a){this.treeLoad(a)},treeLoad:function(a,b){var c,d=a.tree,e=a.widget.element,f=g.extend({},a,{node:this.rootNode});d.rootNode.children&&this.treeClear(a);if(b=b||this.options.source)"string"===typeof b&&F();else switch(c=e.data("type")||"html",c){case "html":c=e.find(">ul:first");c.addClass("ui-fancytree-source ui-helper-hidden"); b=g.ui.fancytree.parseHtml(c);break;case "json":b=g.parseJSON(e.text());b.children&&(b.title&&(d.title=b.title),b=b.children);break;default:g.error("Invalid data-type: "+c)}return this.nodeLoadChildren(f,b).done(function(){d.render();3===a.options.selectMode&&d.rootNode.fixSelection3FromEndNodes();d._triggerTreeEvent("init",!0)}).fail(function(){d.render();d._triggerTreeEvent("init",!1)})},treeSetFocus:function(a,b,c){b=!1!==b;this.debug("treeSetFocus("+b+"), _calledByNodeSetFocus: "+c);this.debug(" focusNode: "+ this.focusNode);this.debug(" activeNode: "+this.activeNode);b!==this.hasFocus()&&(this._hasFocus=b,this.$container.toggleClass("fancytree-treefocus",b),this._triggerTreeEvent(b?"focusTree":"blurTree"))},reactivate:function(a){var b=this.activeNode;b&&(this.activeNode=null,b.setActive(),a&&b.setFocus())},reload:function(a){this._callHook("treeClear",this);return this._callHook("treeLoad",this,a)},render:function(a,b){return this.rootNode.render(a,b)},setFocus:function(a){return this._callHook("treeSetFocus", this,a)},toDict:function(a,b){var c=this.rootNode.toDict(!0,b);return a?c:c.children},toString:function(){return"<Fancytree(#"+this._id+")>"},_triggerNodeEvent:function(a,b,c,d){b=this._makeHookContext(b,c,d);a=this.widget._trigger(a,c,b);return!1!==a&&b.result!==p?b.result:a},_triggerTreeEvent:function(a,b){var c=this._makeHookContext(this,b),d=this.widget._trigger(a,b,c);return!1!==d&&c.result!==p?c.result:d},visit:function(a){return this.rootNode.visit(a,!1)},warn:function(a){Array.prototype.unshift.call(arguments, this.toString());s("warn",arguments)}};g.widget("ui.fancytree",{options:{activeVisible:!0,ajax:{type:"GET",cache:!1,dataType:"json"},aria:!1,autoActivate:!0,autoCollapse:!1,autoScroll:!1,checkbox:!1,clickFolderMode:4,debugLevel:null,disabled:!1,enableAspx:!0,extensions:[],fx:{height:"toggle",duration:200},generateIds:!1,icons:!0,idPrefix:"ft_",keyboard:!0,keyPathSeparator:"/",minExpandLevel:1,selectMode:2,strings:{loading:"Loading&#8230;",loadError:"Load error!"},tabbable:!0,_classNames:{node:"fancytree-node", folder:"fancytree-folder",combinedExpanderPrefix:"fancytree-exp-",combinedIconPrefix:"fancytree-ico-",hasChildren:"fancytree-has-children",active:"fancytree-active",selected:"fancytree-selected",expanded:"fancytree-expanded",lazy:"fancytree-lazy",focused:"fancytree-focused",partsel:"fancytree-partsel",lastsib:"fancytree-lastsib",loading:"fancytree-loading",error:"fancytree-error"},lazyload:null,postProcess:null},_create:function(){this.tree=new E(this);this.$source=this.source||"json"===this.element.data("type")? this.element:this.element.find(">ul:first");var a,b,c,d=this.options.extensions,e=this.tree;for(c=0;c<d.length;c++){b=d[c];(a=g.ui.fancytree._extensions[b])||g.error("Could not apply extension '"+b+"' (it is not registered, did you forget to include it?)");this.tree.options[b]=g.extend(!0,{},a.options,this.tree.options[b]);m(this.tree.ext[b]===p,"Extension name must not exist as Fancytree.ext attribute: '"+b+"'");this.tree.ext[b]={};var f=this.tree,h=a,k=void 0;for(k in h)"function"===typeof h[k]? "function"===typeof f[k]?f[k]=G(k,f,e,h,b):"_"===k.charAt(0)?f.ext[b][k]=G(k,f,e,h,b):g.error("Could not override tree."+k+". Use prefix '_' to create tree."+b+"._"+k):"options"!==k&&(f.ext[b][k]=h[k]);e=a}this.tree._callHook("treeCreate",this.tree)},_init:function(){this.tree._callHook("treeInit",this.tree);this._bind()},_setOption:function(a,b){var c=!0,d=!1;switch(a){case "aria":case "checkbox":case "icons":case "minExpandLevel":case "tabbable":this.tree._callHook("treeCreate",this.tree);d=!0; break;case "source":c=!1,this.tree._callHook("treeLoad",this.tree,b)}this.tree.debug("set option "+a+"="+b+" <"+typeof b+">");c&&g.Widget.prototype._setOption.apply(this,arguments);d&&this.tree.render(!0,!1)},destroy:function(){this._unbind();this.tree._callHook("treeDestroy",this.tree);this.tree.$div.find(">ul.fancytree-container").remove();this.$source&&this.$source.removeClass("ui-helper-hidden");g.Widget.prototype.destroy.call(this)},_unbind:function(){var a=this.tree._ns;this.element.unbind(a); this.tree.$container.unbind(a);g(w).unbind(a)},_bind:function(){var a=this,b=this.options,c=this.tree,d=c._ns;this._unbind();c.$container.on("focusin"+d+" focusout"+d,function(a){var b=t.getNode(a);a="focusin"===a.type;b?c._callHook("nodeSetFocus",b,a):c._callHook("treeSetFocus",c,a)}).on("selectstart"+d,"span.fancytree-title",function(a){a.preventDefault()}).on("keydown"+d,function(a){if(b.disabled||!1===b.keyboard)return!0;var d,g=c.focusNode,k=c._makeHookContext(g||c,a),l=c.phase;try{return c.phase= "userEvent",d=g?c._triggerNodeEvent("keydown",g,a):c._triggerTreeEvent("keydown",a),"preventNav"===d?d=!0:!1!==d&&(d=c._callHook("nodeKeydown",k)),d}finally{c.phase=l}}).on("click"+d+" dblclick"+d,function(c){if(b.disabled)return!0;var d,g=t.getEventTarget(c);d=g.node;var k=a.tree,l=k.phase;if(!d)return!0;d=k._makeHookContext(d,c);try{switch(k.phase="userEvent",c.type){case "click":return d.targetType=g.type,!1===k._triggerNodeEvent("click",d,c)?!1:k._callHook("nodeClick",d);case "dblclick":return d.targetType= g.type,!1===k._triggerNodeEvent("dblclick",d,c)?!1:k._callHook("nodeDblclick",d)}}finally{k.phase=l}})},getActiveNode:function(){return this.tree.activeNode},getNodeByKey:function(a){return this.tree.getNodeByKey(a)},getRootNode:function(){return this.tree.rootNode},getTree:function(){return this.tree}});t=g.ui.fancytree;g.extend(g.ui.fancytree,{version:"development",buildType:"develop",debugLevel:2,_nextId:1,_nextNodeKey:1,_extensions:{},_FancytreeClass:E,_FancytreeNodeClass:v,jquerySupports:{positionMyOfs:L(g.ui.version, 1,9)},assert:function(a,b){return m(a,b)},debug:function(a){2<=g.ui.fancytree.debugLevel&&s("log",arguments)},error:function(a){s("error",arguments)},getEventTargetType:function(a){return this.getEventTarget(a).type},getEventTarget:function(a){var b=a&&a.target?a.target.className:"";a={node:this.getNode(a.target),type:p};/\bfancytree-title\b/.test(b)?a.type="title":/\bfancytree-expander\b/.test(b)?a.type=!1===a.node.hasChildren()?"prefix":"expander":/\bfancytree-checkbox\b/.test(b)?a.type="checkbox": /\bfancytree-icon\b/.test(b)?a.type="icon":/\bfancytree-node\b/.test(b)&&(a.type="title");return a},getNode:function(a){if(a instanceof v)return a;a.selector!==p?a=a[0]:a.originalEvent!==p&&(a=a.target);for(;a;){if(a.ftnode)return a.ftnode;a=a.parentNode}return null},info:function(a){1<=g.ui.fancytree.debugLevel&&s("info",arguments)},parseHtml:function(a){var b,c,d,e,f,h,k,l=[];a.find(">li").each(function(){var m,n,r=g(this);m=r.find(">span:first",this);n=m.length?null:r.find(">a:first");var q={tooltip:null, data:{}};m.length?q.title=m.html():n&&n.length?(q.title=n.html(),q.data.href=n.attr("href"),q.data.target=n.attr("target"),q.tooltip=n.attr("title")):(q.title=r.html(),e=q.title.search(/<ul/i),0<=e&&(q.title=q.title.substring(0,e)));q.title=g.trim(q.title);c=0;for(d=C.length;c<d;c++)q[C[c]]=p;h=this.className.split(" ");b=[];c=0;for(d=h.length;c<d;c++)k=h[c],K[k]?q[k]=!0:b.push(k);q.extraClasses=b.join(" ");if(f=r.attr("title"))q.tooltip=f;if(f=r.attr("id"))q.key=f;(m=r.data())&&!g.isEmptyObject(m)&& (n=m.json,delete m.json,g.extend(q.data,m),n&&g.extend(q.data,n));a=r.find(">ul:first");q.children=a.length?g.ui.fancytree.parseHtml(a):q.lazy?p:null;l.push(q)});return l},registerExtension:function(a,b){g.ui.fancytree._extensions[a]=b},warn:function(a){s("warn",arguments)}})}})(jQuery,window,document);